<!DOCTYPE html>
<meta name="color-scheme" content="light dark">
<body>
<button onclick="start()">Start</button>
<br>
<br>
<div id="lcd" style="white-space: pre; font-family: monospace;">
</div>
<br>
Supports attaching actual keyboard in Chrome/Firefox.
</body>
<script src="wasmbuild/webmt32.js"></script>
<script>
    'use strict';
    Module().then(module => {
        module.lcdMessage = x => document.querySelector('#lcd').textContent = x.replace(/\x01/g, '*');
        const bufferSize = 8192;
        module._init(bufferSize);
        const channel0 = module._channel(0) / 4;
        const channel1 = module._channel(1) / 4;

        let context;
        const sampleRate = module._sampleRate();

        let isOnPlay = false;
        let next;

        const getBufferSource = () => {
            module._render();
            const buffer = context.createBuffer(2, bufferSize, sampleRate);
            buffer.copyToChannel(module.HEAPF32.subarray(channel0, channel0 + bufferSize), 0);
            buffer.copyToChannel(module.HEAPF32.subarray(channel1, channel1 + bufferSize), 1);
            const bufferSource = context.createBufferSource();
            bufferSource.buffer = buffer;
            bufferSource.connect(context.destination);
            bufferSource.onended = () => {
                if (next === undefined) {
                    isOnPlay = false;
                } else {
                    next.start();
                    if (module._isActive()) {
                        next = getBufferSource();
                    }
                }
            };
            return bufferSource;
        };

        window.start = () => {
            context = new AudioContext();
            module._playMsg(0x7f4591);
            if (!isOnPlay) {
                getBufferSource().start();
                next = getBufferSource();
            }
        }

        if (navigator.requestMIDIAccess) navigator.requestMIDIAccess().then(midi => {
            midi.inputs.forEach(entry => entry.onmidimessage = event => {
                if (event.data.length === 3) {
                    module._playMsg((event.data[2] << 16) + (event.data[1] << 8) + event.data[0]);
                } else console.log(event.data);
            });
        }).catch(console.error);
    });
</script>