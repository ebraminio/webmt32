<!DOCTYPE html>
<meta name="color-scheme" content="light dark">
<body style="white-space: pre; font-family: monospace;"><button onclick="play()">play</button></body>
<script src="wasmbuild/webmt32.js"></script>
<script>
    'use strict';
    Promise.all([
        Module(),
        fetch('mt32_ctrl_1_07.rom').then(x => x.blob()).then(x => x.arrayBuffer()),
        fetch('mt32_pcm.rom').then(x => x.blob()).then(x => x.arrayBuffer()),
    ]).then(([module, ctrl, pcm]) => {
        module.FS.mkdir('/rom');
        module.FS.writeFile('/rom/mt32_ctrl_1_07.rom', new Uint8Array(ctrl));
        module.FS.writeFile('/rom/mt32_pcm.rom', new Uint8Array(pcm));
        module.lcdMessage = x => document.body.append(x + '\n');
        module._init();

        const context = new AudioContext();

        window.play = () => {
            module._playMsg(0x007f4591);

            module._render();
            const result0 = new Float32Array(module.FS.readFile('/result0.pcm').buffer);
            const result1 = new Float32Array(module.FS.readFile('/result1.pcm').buffer);
            const sampleRate = module._sampleRate();

            const buffer = context.createBuffer(2, result0.length, sampleRate);
            buffer.copyToChannel(result0, 0);
            buffer.copyToChannel(result1, 1);

            const activeNode = context.createBufferSource();
            activeNode.buffer = buffer;
            activeNode.connect(context.destination);
            activeNode.start(0);
        };
    });
</script>