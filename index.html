<!DOCTYPE html>
<meta name="color-scheme" content="light dark">
<body>
<button onclick="play()">play</button>
<br>
<br>
<div id="lcd" style="white-space: pre; font-family: monospace;">
</div>
<br>
Supports attaching actual keyboard in Chrome/Firefox.
</body>
<script src="wasmbuild/webmt32.js"></script>
<script>
    'use strict';
    Module().then(module => {
        module.lcdMessage = x => document.querySelector('#lcd').textContent = x.replace(/\x01/g, '*');
        module._init();

        const context = new AudioContext();
        const sampleRate = module._sampleRate();

        window.play = msg => {
            module._playMsg(msg || 0x007f4591);
            module._render();
        };

        module.play = (bufferSize, channel0, channel1, timeOffset) => {
            const buffer = context.createBuffer(2, bufferSize, sampleRate);
            buffer.copyToChannel(module.HEAPF32.subarray(channel0, channel0 + bufferSize), 0);
            buffer.copyToChannel(module.HEAPF32.subarray(channel1, channel1 + bufferSize), 1);

            const activeNode = context.createBufferSource();
            activeNode.buffer = buffer;
            activeNode.connect(context.destination);
            activeNode.start(timeOffset);
        }
    });

    if (navigator.requestMIDIAccess) navigator.requestMIDIAccess().then(midi => {
        midi.inputs.forEach(entry => entry.onmidimessage = event => {
            if (event.data.length === 3) {
                play((event.data[2] << 16) + (event.data[1] << 8) + event.data[0]);
            } else console.log(event.data);
        });
    }).catch(console.error);
</script>