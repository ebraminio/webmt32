<!DOCTYPE html>
<meta name="color-scheme" content="light dark">
<body style="white-space: pre; font-family: monospace;"><button onclick="play()">play</button></body>
<script src="wasmbuild/webmt32.js"></script>
<script>
    'use strict';
    Promise.all([
        Module(),
        fetch('mt32_ctrl_1_07.rom').then(x => x.blob()).then(x => x.arrayBuffer()),
        fetch('mt32_pcm.rom').then(x => x.blob()).then(x => x.arrayBuffer()),
    ]).then(([module, ctrl, pcm]) => {
        module.FS.mkdir('/rom');
        module.FS.writeFile('/rom/mt32_ctrl_1_07.rom', new Uint8Array(ctrl));
        module.FS.writeFile('/rom/mt32_pcm.rom', new Uint8Array(pcm));
        module.lcdMessage = x => document.body.append(x.replace(/\x01/g, '*') + '\n');
        module._init();

        const context = new AudioContext();
        const sampleRate = module._sampleRate();

        window.play = () => {
            module._playMsg(0x007f4591);
            module._render();
        };

        module.play = (bufferSize, channel0, channel1, timeOffset) => {
            const buffer = context.createBuffer(2, bufferSize, sampleRate);
            buffer.copyToChannel(module.HEAPF32.subarray(channel0, channel0 + bufferSize), 0);
            buffer.copyToChannel(module.HEAPF32.subarray(channel1, channel1 + bufferSize), 1);

            const activeNode = context.createBufferSource();
            activeNode.buffer = buffer;
            activeNode.connect(context.destination);
            activeNode.start(timeOffset);
        }
    });
</script>