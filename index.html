<!DOCTYPE html>
<meta name="color-scheme" content="light dark">
<body>
<button onclick="start()">Start</button>
<br>
<br>
<div id="lcd" style="white-space: pre; font-family: monospace;">
</div>
<br>
Supports attaching actual keyboard in Chrome/Firefox.
</body>
<script src="wasmbuild/webmt32.js"></script>
<script>
    'use strict';
    Module().then(module => {
        module.lcdMessage = x => document.querySelector('#lcd').textContent = x.replace(/\x01/g, '*');
        const bufferSize = 4096;
        module._init(bufferSize);
        const channel0 = module._channel(0) / 4;
        const channel1 = module._channel(1) / 4;

        let context;
        const sampleRate = module._sampleRate();

        window.start = () => {
            context = new AudioContext();
            module._playMsg(0x7f4591);
        }

        const getBufferSource = () => {
            module._render();
            const buffer = context.createBuffer(2, bufferSize, sampleRate);
            buffer.copyToChannel(module.HEAPF32.subarray(channel0, channel0 + bufferSize), 0);
            buffer.copyToChannel(module.HEAPF32.subarray(channel1, channel1 + bufferSize), 1);
            const bufferSource = context.createBufferSource();
            bufferSource.buffer = buffer;
            bufferSource.connect(context.destination);
            return bufferSource;
        };

        let isOnPlay = false;
        let lastTime = Date.now();
        setInterval(() => {
            if (context === undefined) return;
            if (!module._isActive()) return;

            if (!isOnPlay) {
                const bufferSource = getBufferSource();
                bufferSource.start();
                bufferSource.onended = () => isOnPlay = false;
                isOnPlay = true;
                lastTime = Date.now() + bufferSource.buffer.duration * 1000;
            }
        }, 1000 * bufferSize / sampleRate);

        if (navigator.requestMIDIAccess) navigator.requestMIDIAccess().then(midi => {
            midi.inputs.forEach(entry => entry.onmidimessage = event => {
                if (event.data.length === 3) {
                    module._playMsg((event.data[2] << 16) + (event.data[1] << 8) + event.data[0]);
                } else console.log(event.data);
            });
        }).catch(console.error);
    });
</script>